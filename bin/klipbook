#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'gli'
require 'klipbook'

class InvalidSourceError < RuntimeError; end

include GLI::App

program_desc "Collates the clippings you've saved on your Kindle into a nice html summary for each book."

config_file '.klipbookrc'

version Klipbook::VERSION

desc 'Number of books to process'
arg_name 'count'
default_value 1
flag [:n, :'num-books']

desc 'Collate your clippings into a html file for each book'
arg_name 'source'
long_desc "Clippings are fetched from the specified source before being collated into a html file.\n\n" +
          "Two sources are currently supported: a file from a Kindle device and the Kindle site itself.\n\n" +
          "Example file formats:\n\n" +
          "   file:path/to/my-clippings-file.txt\n\n" +
          "   site:my-kindle-user@blah.com:my-kindle-password"
command :collate do |c|

  c.desc 'The directory path where collated files are written'
  c.default_value Dir.pwd
  c.arg_name 'Directory'
  c.flag [:o, :'output-dir']

  c.desc 'Force overwrite of any existing collated files'
  c.switch [:f, :force]

  c.action do |globals,options,args|
    books = fetch_books(args[0], globals[:n].to_i)
    Klipbook::Collator.new(books).summarise_all_books(output_dir, globals[:force])
  end
end

desc 'List available books'
arg_name 'source'
long_desc "Clippings are fetched from the specified source before being listed to screen.\n\n" +
          "Two sources are currently supported: a file from a Kindle device and the Kindle site itself.\n\n" +
          "Example file formats:\n\n" +
          "   file:path/to/my-clippings-file.txt\n\n" +
          "   site:my-kindle-user@blah.com:my-kindle-password"
command :list do |c|
  c.action do |globals,options,args|
    books = fetch_books(args[0], globals[:n].to_i)
    Klipbook::Printer.new(books).print
  end
end


SOURCE_HELP = "Please provide a valid source.\n" +
              "e.g.\n" +
              "     file:path/to/my-clippings-file.txt\n" +
              "     site:my-kindle-user@blah.com:my-kindle-password"

pre do |globals,command,options,args|
  all_good = true

  if args.empty?
    $stderr.puts SOURCE_HELP
    all_good = false
  end

  if options[:o] && !File.exist?(options[:o])
    $stderr.puts "Output directory doesn't exist: #{options[:o]}"
    all_good = false
  end

  if globals[:n].to_i == 0
    $stderr.puts 'Specify a number of books greater than 0'
    all_good = false
  end

  all_good
end

on_error do |exception|
  if exception.is_a?(InvalidSourceError)
    $stderr.puts SOURCE_HELP
  end

  true
end

def valid_source(source)
  source =~ /(file:|site:.+:.+)/
end

def fetch_books(source_spec, max_books)
  if (source_spec =~ /file:(.+)/)
    # TODO Catch and wrap these guys
    raw_file = File.open($1, 'r')
    Klipbook::Sources::KindleDevice::File.new(raw_file.read.strip, max_books).books
  elsif (source_spec =~ /site:(.+):(.+)/)
    username = $1
    password = $2
    Klipbook::Sources::AmazonSite::Scraper.new(username, password, max_books).books
  else
    raise InvalidSourceError
  end
end

exit run(ARGV)

